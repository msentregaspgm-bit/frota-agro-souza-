<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Status da Frota</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#2e7d32" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <style>
    body {
      background-color: #e8f5e9;
      font-family: 'Segoe UI', sans-serif;
      transition: background-color .3s, color .3s;
    }
    body.dark-mode {
      background-color: #1b1f1b;
      color: #f4f4f4;
    }
    h1 { color: #2e7d32; text-align: center; margin: 10px 0; }
    body.dark-mode h1 { color: #a5d6a7; }
    .logo-container { text-align: center; margin: 10px 0; }
    .logo-container img { width: 140px; border-radius: 8px; }
    .filters { background: #fff; padding: 10px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); margin-bottom: 10px; }
    body.dark-mode .filters { background: #2b2b2b; }
    .filters select, .filters button { margin: 4px; padding: 6px 10px; border-radius: 6px; }
    #map { height: 420px; border-radius: 10px; margin-bottom: 10px; }
    .card { border-radius: 12px; box-shadow: 0 3px 8px rgba(0,0,0,0.1); transition: transform .2s; }
    .card:hover { transform: translateY(-3px); }
    body.dark-mode .card { background-color: #2a2a2a; color: #eee; }
    .status-carregado { color: #198754; }
    .status-descarregando { color: #ffc107; }
    .status-parado { color: #dc3545; }
    #loading {
      position: fixed; inset: 0; display: flex; align-items: center; justify-content: center;
      background-color: #fff; z-index: 9999; transition: opacity .5s;
    }
    body.dark-mode #loading { background-color: #1b1f1b; }
    #loading img { width: 120px; animation: pulse 2s infinite; }
    @keyframes pulse { 0%,100% { opacity: .8 } 50% { opacity: 1 } }
  </style>
</head>
<body>
  <div id="loading"><img src="icons/icon-512.png" alt="Logo Souza"></div>
  <div class="container">
    <div class="logo-container"><img src="icons/icon-512.png" alt="Logo Souza"></div>
    <h1>Status da Frota</h1>

    <div class="filters text-center">
      <select id="filterProduto"><option value="">ğŸ›¢ï¸ Produto</option></select>
      <select id="filterStatus"><option value="">ğŸš› Status</option></select>
      <select id="filterDestino"><option value="">ğŸ¯ Destino</option></select>
      <select id="filterPosicao"><option value="">ğŸ“ PosiÃ§Ã£o</option></select>
      <button id="clearFilters" class="btn btn-outline-secondary btn-sm">ğŸ§¹ Limpar</button>
      <button id="refreshBtn" class="btn btn-success btn-sm">ğŸ”„ Atualizar</button>
      <button id="darkModeBtn" class="btn btn-dark btn-sm">ğŸŒ™</button>
    </div>

    <div id="map"></div>
    <div id="frotaContainer" class="row g-3"></div>
  </div>

  <script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbyH4y5jntGwQUewTj2kU3Jw-nqcTrhDmqA6UNH-n_P2xSL65nUzUtVJGYIcecqBPCBn/exec";
    let dadosOriginais = [], map, markers = L.markerClusterGroup();

    async function buscarDados() {
      const loading = document.getElementById('loading');
      loading.style.display = 'flex';
      try {
        const r = await fetch(scriptURL);
        const data = await r.json();
        dadosOriginais = data;
        preencherFiltros(data);
        renderizarFrota(data);
      } catch (e) {
        alert('Erro ao carregar dados.');
      } finally {
        setTimeout(()=>loading.style.opacity='0',500);
        setTimeout(()=>loading.style.display='none',1000);
      }
    }

    function preencherFiltros(dados){
      const sets = {Produto:new Set(),Status:new Set(),Destino:new Set(),PosiÃ§Ã£o:new Set()};
      dados.forEach(v=>{for(const k in sets) if(v[k]) sets[k].add(v[k]);});
      for(const k in sets){
        const s=document.getElementById('filter'+k);
        s.innerHTML=`<option value="">${s.options[0].text}</option>`;
        sets[k].forEach(v=>s.innerHTML+=`<option>${v}</option>`);
      }
    }

    function aplicarFiltros(){
      const f = {
        Produto:filterProduto.value,
        Status:filterStatus.value,
        Destino:filterDestino.value,
        PosiÃ§Ã£o:filterPosicao.value
      };
      const filtrados = dadosOriginais.filter(v=>
        (!f.Produto || v.Produto==f.Produto) &&
        (!f.Status || v.Status==f.Status) &&
        (!f.Destino || v.Destino==f.Destino) &&
        (!f.PosiÃ§Ã£o || v["PosiÃ§Ã£o"]==f.PosiÃ§Ã£o)
      );
      renderizarFrota(filtrados);
    }

    function limparFiltros(){
      document.querySelectorAll('.filters select').forEach(s=>s.value='');
      renderizarFrota(dadosOriginais);
    }

    async function renderizarFrota(dados){
      const c=document.getElementById('frotaContainer'); c.innerHTML='';
      if(!map){
        map=L.map('map').setView([-15.78,-47.93],5);
        const sat=L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');
        const labels=L.tileLayer('https://services.arcgisonline.com/arcgis/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}');
        sat.addTo(map); labels.addTo(map);
        map.addLayer(markers);
      }
      markers.clearLayers();
      for(const v of dados){
        let latlng=null;
        const pos=v["PosiÃ§Ã£o"]||'';
        const match=pos.match(/(-?\\d+\\.\\d+),\\s*(-?\\d+\\.\\d+)/);
        if(match){latlng=[parseFloat(match[1]),parseFloat(match[2])];}
        const s=(v.Status||'').toLowerCase();
        const color=s.includes('carregado')?'green':s.includes('descarregando')?'orange':'red';
        if(latlng){
          const marker=L.circleMarker(latlng,{radius:8,color,fillColor:color,fillOpacity:0.9});
          marker.bindPopup(`<div style='color:white'><b>${v.Frota}</b><br>${v.Status}<br>${v.Produto}<br>${v.Destino||''}<br>${v["PosiÃ§Ã£o"]}</div>`);
          markers.addLayer(marker);
        }
        const statusClass=s.includes('carregado')?'status-carregado':s.includes('descarregando')?'status-descarregando':'status-parado';
        c.innerHTML+=`
          <div class='col-6 col-md-3'>
            <div class='card p-2'>
              <h6>ğŸš› ${v.Frota||'-'}</h6>
              <p class='${statusClass}'>${v.Status||'-'}</p>
              <p>ğŸ›¢ï¸ ${v.Produto||'-'}</p>
              <p>ğŸ¯ ${v.Destino||'-'}</p>
              <p>ğŸ“ ${v["PosiÃ§Ã£o"]||'-'}</p>
            </div>
          </div>`;
      }
    }

    document.getElementById('refreshBtn').onclick=buscarDados;
    document.getElementById('darkModeBtn').onclick=()=>document.body.classList.toggle('dark-mode');
    document.getElementById('clearFilters').onclick=limparFiltros;
    ["filterProduto","filterStatus","filterDestino","filterPosicao"].forEach(id=>document.getElementById(id).addEventListener("change",aplicarFiltros));
    window.onload=buscarDados;
  </script>
</body>
</html>
