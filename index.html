<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Status da Frota</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2e7d32">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    body { background-color: #e8f5e9; font-family: 'Segoe UI', sans-serif; transition: background-color .3s,color .3s; }
    body.dark-mode { background-color: #1b1f1b; color: #e0e0e0; }
    h1 { color: #2e7d32; text-align:center; margin:20px 0; }
    body.dark-mode h1 { color: #a5d6a7; }
    .filters select { margin: 5px; border-radius: 8px; padding: 6px; }
    #map { height: 450px; border-radius: 12px; margin-bottom: 20px; }
    .card { border-radius: 10px; box-shadow: 0 3px 8px rgba(0,0,0,0.1); background-color: #fff; }
    body.dark-mode .card { background-color: #2a2a2a; color: #ddd; }
    .status-carregado { color:#198754; } .status-descarregando{ color:#ffc107; } .status-parado{ color:#dc3545; }
    .footer { text-align:center; color:#6c757d; margin:15px 0; }
    .logo-container { text-align:center; }
    .logo-container img { width:160px; border-radius:10px; margin-bottom:10px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo-container"><img src="icons/icon-512.png" alt="Logo"></div>
    <h1>Status da Frota</h1>

    <div class="text-center mb-2">
      <button id="refreshBtn" class="btn btn-success btn-sm">ðŸ”„ Atualizar</button>
      <button id="darkModeBtn" class="btn btn-dark btn-sm">ðŸŒ™ Modo Noturno</button>
    </div>

    <div class="filters text-center">
      <select id="filterProduto"><option value="">Produto</option></select>
      <select id="filterStatus"><option value="">Status</option></select>
      <select id="filterDestino"><option value="">Destino</option></select>
      <select id="filterPosicao"><option value="">PosiÃ§Ã£o</option></select>
    </div>

    <div id="map"></div>
    <div id="frotaContainer" class="row g-3"></div>
    <div class="footer">Â© 2025 Souza Transportes</div>
  </div>

  <script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbyH4y5jntGwQUewTj2kU3Jw-nqcTrhDmqA6UNH-n_P2xSL65nUzUtVJGYIcecqBPCBn/exec";
    let dadosOriginais = [];
    let map, markers = [];

    async function buscarDados() {
      document.getElementById("frotaContainer").innerHTML = "<p class='text-center text-secondary'>Carregando...</p>";
      try {
        const r = await fetch(scriptURL);
        const data = await r.json();
        dadosOriginais = data;
        preencherFiltros(data);
        renderizarFrota(data);
      } catch (e) {
        document.getElementById("frotaContainer").innerHTML = "<p class='text-center text-danger'>Erro ao carregar dados.</p>";
      }
    }

    function preencherFiltros(dados){
      const produtos=new Set(),status=new Set(),destinos=new Set(),posicoes=new Set();
      dados.forEach(v=>{if(v.Produto)produtos.add(v.Produto);if(v.Status)status.add(v.Status);if(v.Destino)destinos.add(v.Destino);if(v["PosiÃ§Ã£o"])posicoes.add(v["PosiÃ§Ã£o"]);});
      preencherSelect("filterProduto",produtos);
      preencherSelect("filterStatus",status);
      preencherSelect("filterDestino",destinos);
      preencherSelect("filterPosicao",posicoes);
    }
    function preencherSelect(id,set){const s=document.getElementById(id);s.innerHTML="<option value=''>"+s.options[0].text+"</option>";set.forEach(v=>{s.innerHTML+=`<option value="${v}">${v}</option>`});}
    function aplicarFiltros(){
      const fP=document.getElementById("filterProduto").value;
      const fS=document.getElementById("filterStatus").value;
      const fD=document.getElementById("filterDestino").value;
      const fL=document.getElementById("filterPosicao").value;
      let filtrados=dadosOriginais.filter(v=>(!fP||v.Produto==fP)&&(!fS||v.Status==fS)&&(!fD||v.Destino==fD)&&(!fL||v["PosiÃ§Ã£o"]==fL));
      renderizarFrota(filtrados);
    }
    ["filterProduto","filterStatus","filterDestino","filterPosicao"].forEach(id=>document.getElementById(id).addEventListener("change",aplicarFiltros));

    async function renderizarFrota(dados){
      const c=document.getElementById("frotaContainer");
      c.innerHTML="";
      if(!map){
        map=L.map('map').setView([-15.78,-47.93],5);
        const imagery=L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');
        const labels=L.tileLayer('https://services.arcgisonline.com/arcgis/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}',{attribution:'Esri'});
        imagery.addTo(map); labels.addTo(map);
      }
      markers.forEach(m=>map.removeLayer(m));markers=[];
      const group=[];
      for(const v of dados){
        let latlng=null;let pos=v["PosiÃ§Ã£o"]||"";
        const match=pos.match(/(-?\d+\.\d+),\s*(-?\d+\.\d+)/);
        if(match){latlng=[parseFloat(match[1]),parseFloat(match[2])];}
        const s=(v.Status||'').toLowerCase();
        const color=s.includes('carregado')?'green':s.includes('descarregando')?'orange':'red';
        if(latlng){
          const marker=L.circleMarker(latlng,{radius:7,color,fillColor:color,fillOpacity:0.9}).addTo(map);
          marker.bindPopup(`<b>${v.Frota}</b><br>${v.Status}<br>${v.Produto}<br>${v.Destino||''}<br>${v["PosiÃ§Ã£o"]}`);
          markers.push(marker);group.push(marker);
        }
        c.innerHTML+=`
          <div class='col-6 col-md-3'>
            <div class='card p-2'>
              <h6>${v.Frota||'-'}</h6>
              <p class='${s.includes("carregado")?"status-carregado":s.includes("descarregando")?"status-descarregando":"status-parado"}'>${v.Status||'-'}</p>
              <p><strong>Produto:</strong> ${v.Produto||'-'}</p>
              <p><strong>Destino:</strong> ${v.Destino||'-'}</p>
              <p><strong>PosiÃ§Ã£o:</strong> ${v["PosiÃ§Ã£o"]||'-'}</p>
            </div>
          </div>`;
      }
      if(group.length){const g=L.featureGroup(group);map.fitBounds(g.getBounds(),{padding:[30,30]});}
    }

    document.getElementById("refreshBtn").addEventListener("click",buscarDados);
    document.getElementById("darkModeBtn").addEventListener("click",()=>{
      document.body.classList.toggle("dark-mode");
    });
    window.onload=buscarDados;
  </script>
</body>
</html>