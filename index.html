<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Status da Frota</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2e7d32">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body { background-color: #e8f5e9; font-family: 'Segoe UI', sans-serif; padding: 15px; }
    h1 { color: #2e7d32; font-weight: 700; margin-bottom: 20px; text-align: center; }
    .card { border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.08); background-color: #fff; }
    .status-carregado { color: #198754; } .status-descarregando { color: #ff9800; } .status-parado { color: #dc3545; }
    #map { height: 400px; border-radius: 10px; margin-top: 15px; }
    .footer { text-align: center; color: #6c757d; margin-top: 20px; font-size: 0.9rem; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Status da Frota</h1>
    <div class="text-center mb-3">
      <button id="refreshBtn" class="btn btn-success btn-sm">ðŸ”„ Atualizar</button>
    </div>
    <div class="row mb-3">
      <div class="col-6"><canvas id="graficoStatus"></canvas></div>
      <div class="col-6"><canvas id="graficoProdutos"></canvas></div>
    </div>
    <div id="map"></div>
    <div id="frotaContainer" class="row g-3 mt-3"></div>
    <div class="footer">Â© 2025 Souza Transportes</div>
  </div>
  <script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbyH4y5jntGwQUewTj2kU3Jw-nqcTrhDmqA6UNH-n_P2xSL65nUzUtVJGYIcecqBPCBn/exec";
    let chartStatus, chartProdutos, map, markers = [];
    function atualizarGraficoStatus(dados) {
      const ctx = document.getElementById('graficoStatus').getContext('2d');
      const statusCounts = { Carregado: 0, Descarregando: 0, Parado: 0 };
      dados.forEach(v => {
        const s = (v.Status || '').toLowerCase();
        if (s.includes('carregado')) statusCounts.Carregado++;
        else if (s.includes('descarregando')) statusCounts.Descarregando++;
        else statusCounts.Parado++;
      });
      if (chartStatus) chartStatus.destroy();
      chartStatus = new Chart(ctx, {
        type: 'doughnut',
        data: { labels: Object.keys(statusCounts), datasets: [{ data: Object.values(statusCounts), backgroundColor: ['#198754','#ff9800','#dc3545'] }] },
        options: { plugins: { legend: { position: 'bottom' } } }
      });
    }
    function atualizarGraficoProdutos(dados) {
      const ctx = document.getElementById('graficoProdutos').getContext('2d');
      const produtosCount = {};
      dados.forEach(v => { const p = v.Produto || 'Indefinido'; produtosCount[p] = (produtosCount[p] || 0) + 1; });
      if (chartProdutos) chartProdutos.destroy();
      chartProdutos = new Chart(ctx, {
        type: 'doughnut',
        data: { labels: Object.keys(produtosCount), datasets: [{ data: Object.values(produtosCount), backgroundColor: ['#4caf50','#81c784','#aed581','#dce775','#fff176'] }] },
        options: { plugins: { legend: { position: 'bottom' } } }
      });
    }
    async function atualizarMapa(dados) {
      if (!map) {
        map = L.map('map').setView([-15.78, -47.93], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap' }).addTo(map);
      }
      markers.forEach(m => map.removeLayer(m)); markers = [];
      for (const v of dados) {
        const pos = v["PosiÃ§Ã£o"] || ''; const s = (v.Status || '').toLowerCase();
        const color = s.includes('carregado') ? 'green' : s.includes('descarregando') ? 'orange' : 'red';
        const match = pos.match(/(-?\d+\.\d+),\s*(-?\d+\.\d+)/);
        if (match) {
          const latlng = [parseFloat(match[1]), parseFloat(match[2])];
          const marker = L.circleMarker(latlng, { radius: 6, color, fillColor: color, fillOpacity: 0.9 }).addTo(map);
          marker.bindPopup(`<b>${v.Frota}</b><br>${v.Status}<br>${v.Produto}`);
          markers.push(marker);
        }
      }
    }
    function renderizarFrota(dados) {
      const c = document.getElementById("frotaContainer"); c.innerHTML = "";
      dados.forEach(v => {
        const s = (v.Status || '').toLowerCase();
        const cls = s.includes('carregado') ? 'status-carregado' : s.includes('descarregando') ? 'status-descarregando' : 'status-parado';
        c.innerHTML += `<div class='col-6 col-md-3'><div class='card p-2'><h6>${v.Frota}</h6><p class='${cls}'>${v.Status}</p><p>${v.Produto}</p></div></div>`;
      });
      atualizarGraficoStatus(dados); atualizarGraficoProdutos(dados); atualizarMapa(dados);
    }
    async function buscarDados() {
      const c = document.getElementById("frotaContainer");
      c.innerHTML = "<p class='text-center'>ðŸ”„ Carregando...</p>";
      try { const r = await fetch(scriptURL); const data = await r.json(); renderizarFrota(data); }
      catch (e) { c.innerHTML = "<p class='text-center text-danger'>Erro ao carregar dados.</p>"; }
    }
    document.getElementById('refreshBtn').addEventListener('click', buscarDados);
    window.onload = buscarDados;
  </script>
</body>
</html>